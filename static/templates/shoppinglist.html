{% extends "base.html" %}
{% block content %}
<!-- Modal list item -->
<div id="modal-list-item" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
    <h3 id="myModalLabel">Add item to list</h3>
  </div>
  <div class="modal-body">
  	<form id="modal-form" class="form-horizontal" action="/Lists/{{ list_id }}" method="post">
  		<fieldset>
  		<div class="control-group">
			<label class="control-label">Product</label>
			<div class="controls">
				<input type="text" id="product-query" name="description" autofocus="autofocus" autocomplete="off" data-provide='typeahead'>
			</div>
			<label class="control-label">Quantity</label>
			<div class="controls">
				<input type="text" name="quantity" placeholder="1" value="1">
			</div>
  		</div>
  		</fieldset>
  	</form>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <input type="submit" id="modal-form-submit" class="btn btn-primary" value="Add">
  </div>
</div>

<!--  Page -->
  	<div class="row">
  		<div class="span3"><h3>{{ shopping_list.name }}</h3></div>
  		<div class="span1">
  			<a class="btn btn-primary" data-toggle="modal" data-target="#modal-list-item"><i class="icon-plus icon-white"></i> Add</a>
  		</div>
  	</div>
	
  	<div class="row">
  		<div class="span12">
		  	<ul id="sortable" class="unstyled">
		  	{% for item in list_items %}
				<li class="ui-state-default"><div style="position:relative" id="{{item.key().id_or_name()}}"><i class="icon-align-justify"></i>{{item.description}} - {{item.quantity}}</div></li>  	
		  	{% endfor %}
		  	</ul>
		</div>
	</div>
  </body>
</html>                                          
{% endblock %}
{% block javascript %}
	<script>
		function showDeleteButton(currentDiv)
		{
			var deleteBtn = document.createElement("button");
			deleteBtn.appendChild(document.createTextNode("delete"));
			deleteBtn.className += ("delete-btn btn btn-danger btn-small");
			deleteBtn.style = "btn";
			deleteBtn.style.position = "absolute";
			deleteBtn.style.right = "6px";
			currentDiv.appendChild(deleteBtn);
			deleteBtn.style.top = (currentDiv.clientHeight - deleteBtn.clientHeight) / 2 + "px";
			deleteBtn.style.opacity = 1;
		}
		
		function hideDeleteButton(currentDiv)
		{
			var deleteBtn = $(currentDiv).children(".delete-btn")[0];
		    //deleteBtn.style.opacity = 0;
    		//transform(deleteBtn, "translate3d(20px,0,0)"); // use 3d for hardware acceleration
			currentDiv.removeChild(deleteBtn);
		}
		
		function transform(deleteBtn, style) {
    		deleteBtn.style.transform = style;
    		deleteBtn.style.webkitTransform = style;
    		deleteBtn.style.mozTransform = style;
    		deleteBtn.style.oTransform = style;
  		}
		
		$(function() {
			var modalShown = false;
			$(document).ready(function() {
				var listItems = document.getElementById('sortable').getElementsByTagName('li')
				for (var i = 0; i < listItems.length; ++i) {
					Hammer(listItems[i], {
							swipe_velocity : 0.2
							}).on("swiperight", function(e) {
									var currentDiv = e.target;
									if (currentDiv.localName != "div")
									{
										currentDiv = e.target.firstChild;
									}
									var button = $(".delete-btn");
									if (button.length == 0)
									{
										showDeleteButton(currentDiv);
									} else {
										var buttonDiv = button[0].parentNode;
										hideDeleteButton(buttonDiv);
										if (buttonDiv != currentDiv)
										{
											showDeleteButton(currentDiv);
										}
									}
								});
				}
				$(function() {
				    $( "#sortable" ).sortable({
				    	tolerance: 'pointer',
				    	handle: '.icon-align-justify',
	  					axis: 'y',
	  					delay: 100,
	  					distance: 10
				    });
				    $( "#sortable" ).disableSelection();
				  });			
				$(document).keypress(function(e){
				 var e=window.event || e
				 if (String.fromCharCode(e.charCode) == 'a') {
				 	$('#modal-list-item').modal();
				 }
				 if (e.charCode == 13) {
				 	if (modalShown) {
				    	$('#modal-form').submit();
							 	$('#modal-list-item').modal('hide');
				    }
				 }
				})
				$('#modal-list-item').on('shown', function () {
					modalShown = true;
				  $('#product-query').focus();
				})				
				$('#modal-list-item').on('hidden', function () {
					modalShown = false;
				  $('#product-query').val('');
				})				
				 $('#modal-form-submit').on('click', function(e){
					    e.preventDefault();
					    $('#modal-form').submit();
				  });

				  $("#product-query").typeahead({
					      minLength: 1,
					      source: function(query, process) {
					          $.get('/Products', { q: query.toLowerCase() }, function(data) {
									var newData = [];
					    			$.each(data, function(){
					        			newData.push(this.name);
					    			});	                
					    			process(newData);
				          	  });
				      	  }
				    });
			});
		})
	</script>
{% endblock %}
	